trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Init
    displayName: 'No dependency stage'
    jobs:
      - job: BuildJob
        displayName: 'Build Job'
        steps:
          - script: echo 'Initial stage set-up'
            displayName: 'Initial stage set-up'

  - stage: Linting
    displayName: 'Run Linting'
    dependsOn: Init
    jobs:
      - job: LintPython
        displayName: 'Lint Python Code to PEP8 standards'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python 3.x'
            inputs:
              versionSpec: '3.x'

          - script: |
              pip install --upgrade pip
              pip install uv
              uv tool install ruff
              uv run ruff format $(Build.SourcesDirectory)/Python/maths.py
              uv run ruff check --fix $(Build.SourcesDirectory)/Python/maths.py
            displayName: 'Code linting'
      
      - job: SonarQubeAnalysis
        displayName: 'Run SonarScanner CLI'
        steps:
          - script: |
              export SONAR_SCANNER_VERSION=7.2.0.5079
              export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux-x64
              curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip \
                https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux-x64.zip
              unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
              export PATH=$SONAR_SCANNER_HOME/bin:$PATH

              sonar-scanner \
                -Dsonar.organization=ado-sonarqube \
                -Dsonar.projectKey=ado-sonarqube_ad \
                -Dsonar.login=$(SONAR_TOKEN)
            displayName: 'Install and run SonarScanner'
            env:
              SONAR_TOKEN: $(SONAR_TOKEN)
          
  - stage: Testing
    displayName: 'Run Unit Tests'
    dependsOn: Linting
    jobs:
      - job: RunTests
        displayName: 'Unit Tests'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python 3.x'
            inputs:
              versionSpec: '3.x'

          - script: |
              pip install --upgrade pip
              pip install pytest
              pytest $(Build.SourcesDirectory)/Python/test_maths_addition.py
            displayName: 'Run pytest on maths.py'
