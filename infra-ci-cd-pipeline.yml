# trigger:
#   branches:
#     include:
#       - main

# pr:
#   branches:
#     include:
#       - main

pool:
  vmImage: 'ubuntu-latest'

parameters:
  - name: environment_components
    type: object
    default:
      - deployment: sbox
        environment: sbox
        landing_zones: 
          - landing_zone: '00'
            Client_ID: $(SBOX_CLIENT_ID)
            Subscription_ID: $(SBOX_SUBSCRIPTION_ID)
            Client_Secret: $(SBOX_CLIENT_SECRET)
            Tenant_ID: $(TENANT_ID)
            StorageAccount: 'devops00sasbox'
            ResourceGroup: 'devops00-rg-sbox'
            KeyVaultName: 'devops00-kv-sbox'

      - deployment: stg
        environment: stg
        landing_zones: 
          - landing_zone: '00'
            Client_ID: $(STG_CLIENT_ID)
            Client_Secret: $(STG_CLIENT_SECRET)
            Subscription_ID: $(STG_SUBSCRIPTION_ID)
            Tenant_ID: $(TENANT_ID)
            StorageAccount: 'devops00sastg'
            ResourceGroup: 'devops00-rg-stg'
            KeyVaultName: 'devops00-kv-stg'

      - deployment: prod
        environment: prod
        landing_zones: 
          - landing_zone: '00'
            Client_ID: $(PROD_CLIENT_ID)
            Subscription_ID: $(PROD_SUBSCRIPTION_ID)
            Client_Secret: $(PROD_CLIENT_SECRET)
            Tenant_ID: $(TENANT_ID)
            StorageAccount: 'devops00saprod'
            ResourceGroup: 'devops00-rg-prod'
            KeyVaultName: 'devops00-kv-prod'

stages:
  - stage: Init
    displayName: 'No dependency stage'
    jobs:
      - job: BuildJob
        displayName: 'Build Job'
        steps:
          - script: echo 'Initial stage set-up'
            displayName: 'Initial stage set-up'

  - ${{ each deployment in parameters.environment_components }}:
    - ${{ if or(eq(deployment.environment, 'stg'), eq(deployment.environment, 'prod')) }}:
      - stage: Manual_Approval_${{ deployment.environment }}
        displayName: 'Manual Approval for ${{ deployment.environment }}'
        dependsOn: Init
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
        jobs:
          - job: waitForValidation
            displayName: Wait for Manual Validation
            pool: server
            steps:
              - task: ManualValidation@1
                timeoutInMinutes: 23160
                inputs:
                  approvers: andrew.mcdevitt@hmcts.net
                  instructions: Please validate the build configuration and resume

  - ${{ each deployment in parameters.environment_components }}:
    - ${{ each lz in deployment.landing_zones}}:
      - stage: Bootstrap_${{ deployment.environment }}_${{ lz.landing_zone }}
        displayName: 'Initialise Terraform Backend'
        ${{ if or(eq(deployment.environment, 'stg'), eq(deployment.environment, 'prod')) }}:
          dependsOn: Manual_Approval_${{ deployment.environment }}
        ${{ else }}:
          dependsOn: Init
        jobs:
        - job: BuildAndBootstrap
          displayName: 'Bootstrap TF Backend'
          pool:
            vmImage: 'ubuntu-latest'
          steps:
          - script: |
              echo "Logging in with SP..."
              az login --service-principal \
                  --username ${{ lz.Client_ID }} \
                  --password ${{ lz.Client_Secret }} \
                  --tenant ${{ lz.Tenant_ID }}

              echo "Checking subscriptions available to SP..."
              az account list --query "[].{name:name, id:id}" -o table

              az account set --subscription ${{ lz.Subscription_ID }}
              echo "Account Subscription set to ${{ lz.Subscription_ID }}"

              echo "Confirm current subscription..."
              az account show --output table
              echo "Success! Logged in with SP ${{ lz.Client_ID }}"

              echo 'Create Resource Group'
              az group create \
                  --name ${{ lz.ResourceGroup }} \
                  --location "UK South"

              echo 'Create Storage Account'
              az storage account create --name ${{ lz.StorageAccount }} \
                  --resource-group ${{ lz.ResourceGroup }} \
                  --location "UK South" \
                  --sku Standard_LRS \
                  --kind StorageV2 \
                  --enable-hierarchical-namespace true

              echo "Assigning SP Blob Contributor Access"
              az role assignment create \
                --assignee "${{ lz.Client_ID }}" \
                --role "Storage Blob Data Contributor" \
                --scope "/subscriptions/${{ lz.Subscription_ID }}/resourceGroups/${{ lz.ResourceGroup }}/providers/Microsoft.Storage/storageAccounts/${{ lz.StorageAccount }}"

              echo "Retrieving Storage Account Key"
              storage_account_key=$(az storage account keys list \
                --resource-group ${{ lz.ResourceGroup }} \
                --account-name ${{ lz.StorageAccount }} \
                --query '[0].value' -o tsv)
              echo "Success! ${{ lz.StorageAccount }} storake account key is $storage_account_key"

              echo "Retrieving Blob Endpoint"
              blob_endpoint=$(az storage account show \
                --resource-group ${{ lz.ResourceGroup }} \
                --name ${{ lz.StorageAccount }} \
                --query "primaryEndpoints.blob" -o tsv)
              echo "Success! ${{ lz.StorageAccount }} blob endpoint is $blob_endpoint"

              echo "Creating tf-backend container if not exists"
              az storage container create \
                --account-name ${{ lz.StorageAccount }} \
                --name tf-backend \
                --account-key $storage_account_key \
                --blob-endpoint $blob_endpoint
              echo "Success! tf-backend container created!"
            displayName: 'Bootstrap TF backend storage (Azure CLI login with SP)' 
        
        - job: TerraformBootstrap
          displayName: 'Terraform Init, Validate, Lint & Plan'
          dependsOn: BuildAndBootstrap
          pool:
            vmImage: 'ubuntu-latest'
          steps:
          - task: TerraformInstaller@0
            inputs:
              terraformVersion: 'latest'
            displayName: 'Install Terraform using TerraformInstaller@0'
          
          - script: |
              echo "Logging in with SP..."
              az login --service-principal \
                  --username ${{ lz.Client_ID }} \
                  --password ${{ lz.Client_Secret }} \
                  --tenant ${{ lz.Tenant_ID }}
              az account set --subscription ${{ lz.Subscription_ID }}
              echo "Account Subscription set to ${{ lz.Subscription_ID }}"
            displayName: 'Azure CLI Login with Service Principal & assign KV permissions'

          - script: |   
              cd $(Build.SourcesDirectory)/terraform           
              terraform --version
              terraform init -input=false \
                -backend-config="resource_group_name=${{ lz.ResourceGroup }}" \
                -backend-config="storage_account_name=${{ lz.StorageAccount }}" \
                -backend-config="container_name=tf-backend" \
                -backend-config="key=${{ lz.landing_zone }}/terraform.tfstate"
            displayName: 'Terraform Init & initialise backend'
          
          - script: |
              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
              tflint --version
            displayName: 'Install TFLint'

          - script: |
              cd $(Build.SourcesDirectory)/terraform
              terraform fmt
            displayName: 'Terraform Format'

          - script: |
              cd $(Build.SourcesDirectory)/terraform
              terraform validate
            displayName: 'Terraform Validate'

          - script: |
              cd $(Build.SourcesDirectory)/terraform
              tflint --init
              tflint
            displayName: 'Terraform Lint'

          - script: |
              cd $(Build.SourcesDirectory)/terraform
              terraform plan \
                -out=tfplan \
                -var env=${{ deployment.environment }} \
                -var="subscription_id=${{ lz.Subscription_ID }}" \
                -var="client_id=${{ lz.Client_ID }}" \
                -lock=false     
              terraform show -no-color tfplan > tfplan.txt
            displayName: 'Terraform Plan'
          
          - publish: "$(Build.SourcesDirectory)/terraform/tfplan"
            artifact: "tfplan_${{ deployment.environment }}_${{ lz.landing_zone }}"
            displayName: "Publish Terraform Plan Artifact"
  
  - ${{ each deployment in parameters.environment_components }}:
    - ${{ each lz in deployment.landing_zones}}:
      - stage: Deployment_${{ deployment.environment }}_${{ lz.landing_zone }}
        displayName: 'Deploy Infrastructure to ${{ deployment.environment }}${{ lz.landing_zone }}'
        dependsOn: Bootstrap_${{ deployment.environment }}_${{ lz.landing_zone }}
        condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

        jobs:
          - job: DeployInfrastructure
            displayName: 'Deploy Infrastructure with Terraform Apply'
            pool:
              vmImage: 'ubuntu-latest'

            steps:
            - task: TerraformInstaller@0
              inputs:
                terraformVersion: 'latest'
              displayName: 'Install Terraform'
          
            - script: |
                echo "Logging in with SP..."
                az login --service-principal \
                    --username ${{ lz.Client_ID }} \
                    --password ${{ lz.Client_Secret }} \
                    --tenant ${{ lz.Tenant_ID }}
                az account set --subscription ${{ lz.Subscription_ID }}
                echo "Account Subscription set to ${{ lz.Subscription_ID }}"
              displayName: 'Azure CLI Login with Service Principal'

            - download: current
              artifact: "tfplan_${{ deployment.environment }}_${{ lz.landing_zone }}"
              patterns: '**/tfplan'
              displayName: 'Download Terraform Plan'

            - script: |
                cp "$(Pipeline.Workspace)/tfplan_${{ deployment.environment }}_${{ lz.landing_zone }}/tfplan" \
                  "$(Build.SourcesDirectory)/terraform/tfplan"
              displayName: 'Copy plan back to terraform directory'

            - script: |
                cd $(Build.SourcesDirectory)/terraform
                terraform init -input=false \
                  -backend-config="resource_group_name=${{ lz.ResourceGroup }}" \
                  -backend-config="storage_account_name=${{ lz.StorageAccount }}" \
                  -backend-config="container_name=tf-backend" \
                  -backend-config="key=${{ lz.landing_zone }}/terraform.tfstate"
              displayName: 'Terraform Init'
            
            - script: |
                cd $(Build.SourcesDirectory)/terraform
                terraform apply -input=false -auto-approve tfplan
              displayName: 'Terraform Apply'


  - ${{ each deployment in parameters.environment_components }}:
    - ${{ if or(eq(deployment.environment, 'stg'), eq(deployment.environment, 'prod')) }}:
      - stage: Build_Docker_Image_${{ deployment.environment }}
        displayName: 'Build Docker Image for ${{ deployment.environment }}'
        dependsOn: Manual_Approval_${{ deployment.environment }}
        jobs:
        - job: Build Backend
          displayName: 'Build Backend'
          pool:
            vmImage: 'ubuntu-latest'
          steps:
          - script: |
              echo "Logging in with SP..."
              az login --service-principal \
                  --username ${{ lz.Client_ID }} \
                  --password ${{ lz.Client_Secret }} \
                  --tenant ${{ lz.Tenant_ID }}

              echo "Checking subscriptions available to SP..."
              az account list --query "[].{name:name, id:id}" -o table

              az account set --subscription ${{ lz.Subscription_ID }}
              echo "Account Subscription set to ${{ lz.Subscription_ID }}"

              echo "Fetching credentials for KeyVault: ${{ lz.KeyVaultName }}"
              ACR_USER=$(az keyvault secret show --vault-name ${{ lz.KeyVaultName }} --name ACR-USERNAME --query value -o tsv)
              ACR_PASS=$(az keyvault secret show --vault-name ${{ lz.KeyVaultName }} --name ACR-PASSWORD --query value -o tsv)

              echo "##vso[task.setvariable variable=acrUser;issecret=true]$ACR_USER"
              echo "##vso[task.setvariable variable=acrPass;issecret=true]$ACR_PASS"

              echo "$ACR_PASS" | docker login filevaultacr${{ deployment.environment }}.azurecr.io -u "$ACR_USER" --password-stdin

              TAG=$(Build.BuildId)
              echo "Using image tag: $TAG"
            displayName: "Login + Fetch secrets from Key Vault"

          - script: |
              set -euo pipefail
              echo "Building backend image..."
              cd $(Build.SourcesDirectory)
              docker build -f Dockerfile.backend -t filevaultacrsbox.azurecr.io/backend:${TAG} ./backend

              echo "Pushing backend image to ACR..."
              docker push filevaultacrsbox.azurecr.io/backend:${TAG}
            displayName: 'Build & Push Backend'
      
          - script: |
              set -euo pipefail
              echo "Deploying backend image to Web App: devopswoc-backend-${{ deployment.environment }} ..."
              az webapp config container set \
                --name devopswoc-backend-${{ deployment.environment }} \
                --resource-group ${{ lz.ResourceGroup }} \
                --docker-custom-image-name filevaultacrsbox.azurecr.io/backend:${TAG} \
                --docker-registry-server-url https://filevaultacrsbox.azurecr.io \
                --docker-registry-server-user "$ACR_USER" \
                --docker-registry-server-password "$ACR_PASS"
            displayName: 'Deploy Backend to Web App'

        - job: Build Frontend
          displayName: 'Build Frontend'
          pool:
            vmImage: 'ubuntu-latest'
          steps:
          - script: |
              echo "Logging in with SP..."
              az login --service-principal \
                  --username ${{ lz.Client_ID }} \
                  --password ${{ lz.Client_Secret }} \
                  --tenant ${{ lz.Tenant_ID }}

              echo "Checking subscriptions available to SP..."
              az account list --query "[].{name:name, id:id}" -o table

              az account set --subscription ${{ lz.Subscription_ID }}
              echo "Account Subscription set to ${{ lz.Subscription_ID }}"

              echo "Fetching credentials for KeyVault: ${{ lz.KeyVaultName }}"
              ACR_USER=$(az keyvault secret show --vault-name ${{ lz.KeyVaultName }} --name ACR-USERNAME --query value -o tsv)
              ACR_PASS=$(az keyvault secret show --vault-name ${{ lz.KeyVaultName }} --name ACR-PASSWORD --query value -o tsv)

              echo "##vso[task.setvariable variable=acrUser;issecret=true]$ACR_USER"
              echo "##vso[task.setvariable variable=acrPass;issecret=true]$ACR_PASS"

              echo "$ACR_PASS" | docker login filevaultacr${{ deployment.environment }}.azurecr.io -u "$ACR_USER" --password-stdin

              TAG=$(Build.BuildId)
              echo "Using image tag: $TAG"
            displayName: "Login + Fetch secrets from Key Vault"

          - script: |
              set -euo pipefail
              echo "Building frontend image..."
              cd $(Build.SourcesDirectory)
              docker build -f Dockerfile.frontend -t filevaultacrsbox.azurecr.io/frontend:${TAG} ./frontend

              echo "Pushing Frontend image to ACR..."
              docker push filevaultacrsbox.azurecr.io/frontend:${TAG}
            displayName: 'Build & Push frontend'
      
          - script: |
              set -euo pipefail
              echo "Deploying frontend image to Web App: devopswoc-frontend-${{ deployment.environment }} ..."
              az webapp config container set \
                --name devopswoc-frontend-${{ deployment.environment }} \
                --resource-group ${{ lz.ResourceGroup }} \
                --docker-custom-image-name filevaultacrsbox.azurecr.io/frontend:${TAG} \
                --docker-registry-server-url https://filevaultacrsbox.azurecr.io \
                --docker-registry-server-user "$ACR_USER" \
                --docker-registry-server-password "$ACR_PASS"
            displayName: 'Deploy frontend to Web App'


              
    
          # - job: GrantSPAccessToKV
          #   displayName: 'Assign SP Access to KV'
          #   dependsOn: DeployInfrastructure
          #   pool:
          #     vmImage: 'ubuntu-latest'
          #   steps:
          #   - script: |
          #       echo "Logging in with SP..."
          #       az login --service-principal \
          #           --username ${{ lz.Client_ID }} \
          #           --password ${{ lz.Client_Secret }} \
          #           --tenant ${{ lz.Tenant_ID }}
          #       az account set --subscription ${{ lz.Subscription_ID }}
          #       echo "Account Subscription set to ${{ lz.Subscription_ID }}"

          #       echo "Assigning SP Key Vault Contributor Access"
          #       az role assignment create \
          #         --assignee "${{ lz.Client_ID }}" \
          #         --role "Key Vault Contributor" \
          #         --scope "/subscriptions/${{ lz.Subscription_ID }}/resourceGroups/${{ lz.ResourceGroup }}/providers/Microsoft.KeyVault/vaults/${{ lz.KeyVaultName }}"
          #     displayName: 'Assign SP Key Vault Contributor Role'


  # - ${{ each deployment in parameters.environment_components }}:
  #   - ${{ each lz in deployment.landing_zones}}:
  #     - stage: Deployment_${{ deployment.environment }}_${{ lz.landing_zone }}
  #       displayName: 'Deploy Infrastructure to ${{ deployment.environment }}${{ lz.landing_zone }}'
  #       dependsOn: Bootstrap_${{ deployment.environment }}_${{ lz.landing_zone }}
  #       condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

  #       jobs:
  #         - job: DeployInfrastructure
  #           displayName: 'Deploy Infrastructure with Terraform Apply'
  #           pool:
  #             vmImage: 'ubuntu-latest'

  #           steps:
  #           - task: TerraformInstaller@0
  #             inputs:
  #               terraformVersion: 'latest'
  #             displayName: 'Install Terraform'

  #           - download: current
  #             artifact: "tfplan_${{ deployment.environment }}_${{ lz.landing_zone }}"
  #             displayName: 'Download Terraform Plan'
          
  #           - script: |
  #               echo "Logging in with SP..."
  #               az login --service-principal \
  #                   --username ${{ lz.Client_ID }} \
  #                   --password ${{ lz.Client_Secret }} \
  #                   --tenant ${{ lz.Tenant_ID }}
  #               az account set --subscription ${{ lz.Subscription_ID }}
  #               echo "Account Subscription set to ${{ lz.Subscription_ID }}"

  #           - script: |
  #               cd $(Build.SourcesDirectory)/terraform
  #               terraform init -input=false \
  #                 -backend-config="resource_group_name=${{ lz.ResourceGroup }}" \
  #                 -backend-config="storage_account_name=${{ lz.StorageAccount }}" \
  #                 -backend-config="container_name=tf-backend" \
  #                 -backend-config="key=${{ lz.landing_zone }}/terraform.tfstate"
  #             displayName: 'Terraform Init'
          
  #           - script: |
  #               cd $(Build.SourcesDirectory)/terraform
  #               terraform fmt
  #             displayName: 'Terraform Format'

  #           - script: |
  #               cd $(Build.SourcesDirectory)/terraform
  #               terraform plan \
  #                 -out=tfplan \
  #                 -var env=${{ deployment.environment }} \
  #                 -var="subscription_id=${{ lz.Subscription_ID }}" \
  #                 -var="client_id=${{ lz.Client_ID }}" \
  #                 -lock=false     
  #               terraform show -no-color tfplan > tfplan.txt
  #             displayName: 'Terraform Plan'

  #           - script: |
  #               cd "$(Pipeline.Workspace)/tfplan_${{ deployment.environment }}_${{ lz.landing_zone }}"
  #               terraform apply -input=false -auto-approve tfplan
  #             displayName: 'Terraform Apply'
